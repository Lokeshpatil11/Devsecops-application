pipeline {
    agent any

    environment {
        IMAGE_NAME = "patillokesh/recipe-app"
        TAG = "${env.BUILD_NUMBER}"    // immutable tag using build number
        DOCKERHUB_CREDENTIALS = 'dockerhub'  // Jenkins DockerHub credentials
        SONARQUBE_SERVER = 'sonarqube'       // Jenkins SonarQube server
        KUBECONFIG_PATH = '/var/jenkins_home/.kube/config'  // mounted kubeconfig
    }

    options {
        timestamps()   // adds timestamps to console logs
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    stages {

        stage('Checkout') {
            steps {
                echo "‚úÖ Checking out source code"
                checkout scm
            }
        }

stage('SonarQube Analysis') {
    steps {
        withCredentials([string(credentialsId: 'sonar-token', variable: 'SONAR_TOKEN')]) {
            sh """
                docker run --rm \
                  -v \$(pwd):/usr/src \
                  sonarsource/sonar-scanner-cli \
                  -Dsonar.projectKey=recipe-app \
                  -Dsonar.sources=/usr/src \
                  -Dsonar.host.url=http://${SONARQUBE_SERVER_URL} \
                  -Dsonar.login=$SONAR_TOKEN
            """
        }
    }
}
        stage('OWASP Dependency Scan') {
            steps {
                echo "üõ° Running OWASP Dependency-Check"
                dependencyCheck additionalArguments: '--scan . --format XML', odcInstallation: 'owasp'
                dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
                archiveArtifacts artifacts: '**/dependency-check-report.html', allowEmptyArchive: true
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "üê≥ Building Docker image"
                sh """
                    docker build -t $IMAGE_NAME:$TAG -f docker/Dockerfile .
                """
            }
        }

        stage('Trivy Scan') {
            steps {
                echo "üîé Running Trivy image scan"
                sh """
                    docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image \
                        --severity HIGH,CRITICAL \
                        --exit-code 1 \
                        $IMAGE_NAME:$TAG
                """
            }
        }

        stage('Push Docker Image') {
            steps {
                echo "üì¶ Pushing image to Docker Hub"
                withCredentials([usernamePassword(
                    credentialsId: DOCKERHUB_CREDENTIALS,
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh """
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker push $IMAGE_NAME:$TAG
                    """
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                echo "üöÄ Deploying to Kubernetes"
                withEnv(["KUBECONFIG=${KUBECONFIG_PATH}"]) {
                    sh """
                        kubectl apply -f k8s/namespace.yaml
                        kubectl apply -f k8s/deployment.yaml
                        kubectl apply -f k8s/service.yaml
                        kubectl set image deployment/recipe-app recipe-app=$IMAGE_NAME:$TAG -n recipe-app
                        kubectl rollout status deployment/recipe-app -n recipe-app
                    """
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Pipeline completed successfully"
        }
        failure {
            echo "‚ùå Pipeline failed ‚Äì check logs for details"
        }
        always {
            archiveArtifacts artifacts: 'k8s/*.yaml', allowEmptyArchive: true
        }
    }
}
